{% extends 'bembechat/base_page.html' %}
{% block title %} {{ room.name }} | {% endblock %}

{% block content %}

<!DOCTYPE html>
{% comment %} Add "load static so the stylesheet can be used" {% endcomment %}
{% load static %}

      <html>
      <head>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
            <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
            rel="stylesheet">
           <link rel="stylesheet" href="{% static 'css/room_page.css' %}" />
      </head>
      <body>
            <div class="body">

                  <div class="editAndDeleteRoom">
                        <a href="{% url 'room_update' slug=room.slug %}" class="edit-room">Edit Room</a>
                        <a href="{% url 'room_delete' slug=room.slug %}" type="submit" class="delete-room">Delete Room</a>
                  </div>

                  <h1 class="title"> {{ room.name }} </h1>
                  <div class="chat-messages" id="chat-messages">
                        {% for message in messages %}
                        <div class="chat-messagess" id="chat-messagess">
                              <div class="card-container">
                                    <div class="user">
                                          <i class="fa-solid fa-user user-icon"></i>
                                          <p class="username-text">{{ message.user.username }}</p>
                                    </div>
                                    <div class="card-and-date">
                                          <div class="card2">{{ message.content }}</div>
                                          <div class="date-and-delete-buttons">
                                                <div class="date">{{ message.date_added }}</div>
                                                <div class="edit-and-delete-message">
                                                      <a href="#" class="edit-message material-icons">edit</a>
                                                      <a href="#" type="submit" class="delete-message material-icons">delete</a>
                                                </div>
                                          </div>
                                    </div>
                              </div><span class="material-icons online-button">circle</span>
                        {% endfor %}
                  </div>
            </div>

            <form method="post" action=".">
                  {% csrf_token %}
                  <div class="input-and-button">
                        <div class="input-message">
                              <input type="inputtext" name="content" placeholder="Type your message" id="chat-message-input">
                        </div>
                        <button class="btn-primary material-icons send-button" type="submit" name="action" id='chat-message-submit'>send</button>
                  </div>
            </form>
      </body>
      </html>

{% endblock %}

{% comment %} Add script {% endcomment %}
{% block scripts %}

{{ room.slug|json_script:"json-roomname" }}
{{ request.user.username|json_script:"json-username" }}

<script>
      const roomName = JSON.parse(document.getElementById("json-roomname").textContent);
      const userName = JSON.parse(document.getElementById("json-username").textContent);

      const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/'
            + roomName
            + '/'
      );

      chatSocket.onmessage = function(event){
            console.log('onmessage')

            const data = JSON.parse(event.data);

            //console.log(event);

            // Capture the the time when the message is sent.
            const formattedDate = new Date()

            // Format time and add it to the date field
            const newDate = formattedDate.toLocaleDateString("en-US") + " " + formattedDate.toLocaleTimeString("en-US")

            const arrayMonths = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
            const month = arrayMonths[parseInt(newDate.charAt(0)) - 1]
            let day;

            if(newDate.substring(3,4) === '/'){
                  day = newDate.substring(2,3)
            }

            if(newDate.substring(3,4) !== '/'){
                  day = newDate.substring(2,4)
            }

            const year = newDate.substring(4,8)
            const time = newDate.substring(8,13)
            const ampm = newDate.substring(17,18).toLowerCase() + '.' + newDate.substring(18,19).toLowerCase() + '.';

            const fullTime = `${month} ${day}, ${year},${time} ${ampm}`
            console.log(newDate)
            console.log(fullTime)

            if (data.message){
                  let html = '<div class="chat-messagess" id="chat-messagess">'
                        html += '<div class="card-container">'
                        html += '<div class="user"> <i class="fa-solid fa-user user-icon"></i><p class="username-text">' + data.username + '</p></div>';
                        html += '<div class="card-and-date"><div class="card2">' + data.message + '</div>'
                        html += '<div class="date">' + fullTime + '</div></div>';

                  document.querySelector('#chat-messages').innerHTML += html;

                  //When the message comesfrom the server, call the scrollBottom function
                  scrollBottom();

            }  else {
                 alert('The message input was empty!');
            }
      }

      chatSocket.onclose = function(event){
            console.log('onclose')
      };

      document.querySelector('#chat-message-submit').onclick = function(event){

            event.preventDefault();

            const messageInput = document.querySelector('#chat-message-input');
            const message = messageInput.value;

            chatSocket.send(JSON.stringify({
                  'message' : message,
                  'username' : userName,
                  'room' : roomName,
            }));

            messageInput.value = '';

            return false;
      }

      // Scroll the message to the botton
      function scrollBottom(){
            const objDiv = document.querySelector('#chat-messages');
            objDiv.scrollTop = objDiv.scrollHeight;
      }

</script>
{% endblock %}