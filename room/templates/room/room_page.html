{% extends 'bembechat/base_page.html' %}
{% block title %} {{ room.name }} | {% endblock %}

{% block content %}

<!DOCTYPE html>
{% comment %} Add "load static so the stylesheet can be used" {% endcomment %}
{% load static %}
      
      <html>
      <head>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
            <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
            rel="stylesheet">
           <link rel="stylesheet" href="{% static 'css/room_page.css' %}" />
      </head>
      <body>
            <h1 class="title"> {{ room.name }} </h1>
            <div class="chat-messages" id="chat-messages">
                  {% for message in messages %}
                  <div class="chat-messagess" id="chat-messagess">
                        <div class="card-container">
                              <div class="user"> 
                                    <i class="fa-solid fa-user user-icon"></i>
                                    <p class="username-text">{{ message.user.username }}</p>
                              </div>
                              <div class="card-and-date">
                                    <div class="card2">{{ message.content }}</div>
                                    <div class="date">{{ message.date_added }}</div>
                              </div>
                        </div>
                  {% endfor %}
                  
                  
                  {% comment %} <div class="card-container">
                        <div class="card-and-date">
                              <div class="card1">
                                    This is some text within a card body.
                              </div>
                              <div class="date">
                                    Tuesday, January 2, 2015
                              </div>
                        </div>
                       
                        <div class="user">
                              <i class="fa-solid fa-user user-icon"></i>
                              <p class="username-text">Username</p>
                        </div> 
                  </div> {% endcomment %}
                  
                  {% comment %} <div class="card-container">
                        <div class="user">
                              <i class="fa-solid fa-user user-icon"></i>
                              <p class="username-text">Username</p>
                        </div> 
                        <div class="card-and-date">
                              <div class="card2">
                                    This is some text within a card body. 
                              </div>
                              <div class="date">
                                    Tuesday, January 2, 2015
                              </div>
                        </div>
                   </div> {% endcomment %}
            </div>
          
            <form method="post" action=".">
                  {% csrf_token %}
                  <div class="input-and-button">
                        <div class="input-message">
                             <input type="inputtext" name="content" placeholder="Type your message" id="chat-message-input">
                        </div>
                        
                        <button class="btn-primary" type="submit" name="action" id='chat-message-submit'>
                              <div class='send'>
                                    <span class="material-icons send-button">send</span>
                              </div>
                              
                        </button>
                  </div>
            </form>
      </body>
      </html>

{% endblock %}

{% comment %} Add script {% endcomment %}
{% block scripts %}

{{ room.slug|json_script:"json-roomname" }}
{{ request.user.username|json_script:"json-username" }}

<script>
      const roomName = JSON.parse(document.getElementById("json-roomname").textContent);
      const userName = JSON.parse(document.getElementById("json-username").textContent);
      {% comment %} const date = JSON.parse(document.getElementById("json-date").textContent); {% endcomment %}

      const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/'
            + roomName
            + '/'
      );

      chatSocket.onmessage = function(event){
            console.log('onmessage')
            
            const data = JSON.parse(event.data);
            
            if (data.message){
                  let html = '<div class="chat-messagess" id="chat-messagess">'
                        html += '<div class="card-container">'
                        html += '<div class="user"> <i class="fa-solid fa-user user-icon"></i><p class="username-text">' + data.username + '</p></div>';
                        html += '<div class="card-and-date"><div class="card2">' + data.message + '</div>'
                        html += '<div class="date">'+ data.date + '</div></div>';
                  
                  document.querySelector('#chat-messages').innerHTML += html;

                  {% comment %} When the message comesfrom the server, call the scrollBottom function {% endcomment %}
                  scrollBottom();
                  
            }  else {
                  alert('The message input was empty!');
            }
      }
      
      chatSocket.onclose = function(event){
            console.log('onclose')
      };

      document.querySelector('#chat-message-submit').onclick = function(event){

            event.preventDefault();

            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            
            chatSocket.send(JSON.stringify({
                  'message' : message,
                  'username' : userName,
                  'room' : roomName,
                  {% comment %} 'date' : date {% endcomment %}
            }));

            messageInputDom.value = '';

            return false;
      }
      
      {% comment %} Scroll the message to the botton {% endcomment %}
      function scrollBottom(){
            const objDiv = document.querySelector('#chat-messages');
            objDiv.scrollTop = objDiv.scrollHeight;
      }

      scrollBottom();

</script>
{% endblock %}